# routing-rules.conf — DevRouter 共通ルーティングルール
# HTTP / HTTPS VirtualHost から Include して使う

DirectoryIndex index.php index.html index.htm
ProxyPreserveHost On
RewriteEngine On

# 1. 管理UI（localhost のみ）
#    API も静的ファイルも DocumentRoot 内のファイルとして直接配信
RewriteCond %{HTTP_HOST} ^(localhost|127\.0\.0\.1|\[::1\])(:\d+)?$
RewriteCond %{REMOTE_ADDR} ^(127\.0\.0\.1|::1)$
RewriteRule ^(.*)$ ${ROUTER_HOME}/public$1 [L]

# 2. ルーター問い合わせ（txt: map 参照、結果を環境変数に格納）
RewriteCond ${router:${lc:%{HTTP_HOST}}} ^(.+)$
RewriteRule .* - [E=ROUTE:%1,NE]

# 3. マッチなし → resolve.php で自動解決
RewriteCond %{ENV:ROUTE} ^$
RewriteRule ^ ${ROUTER_HOME}/public/resolve.php [L]

# 4. リダイレクト（ベースドメイン直アクセス → 管理UIへ）
RewriteCond %{ENV:ROUTE} ^R:(.+)$
RewriteRule ^ %1 [R=302,L]

# 5. WebSocket プロキシ（Upgrade ヘッダ検出時）
RewriteCond %{HTTP:Upgrade} =websocket [NC]
RewriteCond %{ENV:ROUTE} ^https?://(.+)
RewriteRule ^(.*)$ ws://%1$1 [P,L]

# 6. リバースプロキシ（HTTP URL）
RewriteCond %{ENV:ROUTE} ^(https?://.+)
RewriteRule ^(.*)$ %1$1 [P,L]

# 7. ディレクトリ公開（ファイルパス）
RewriteCond %{ENV:ROUTE} ^(/.+)
RewriteRule ^(.*)$ %1$1 [L]

# 8. フォールバック（ROUTE 未設定 — resolve.php が処理するため通常到達しない）
RewriteRule ^ - [R=404,L]
